<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoToMeeting Support</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --g2m-blue: #0066FF;
    --g2m-dark: #0A1628;
    --g2m-mid: #132040;
    --g2m-surface: #1A2D50;
    --g2m-border: rgba(0,102,255,0.2);
    --g2m-text: #E8EDF5;
    --g2m-muted: #7A8FA6;
    --g2m-accent: #00C6FF;
    --g2m-success: #00D68F;
    --g2m-warn: #FFB830;
    --radius: 16px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--g2m-dark);
    color: var(--g2m-text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background-image: 
      radial-gradient(ellipse 60% 50% at 20% 20%, rgba(0,102,255,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 50% 40% at 80% 80%, rgba(0,198,255,0.08) 0%, transparent 60%);
  }

  .widget-container {
    width: 100%;
    max-width: 480px;
    display: flex;
    flex-direction: column;
    height: 720px;
    background: var(--g2m-mid);
    border-radius: var(--radius);
    border: 1px solid var(--g2m-border);
    box-shadow: 0 32px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,102,255,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
    overflow: hidden;
    position: relative;
  }

  /* Header */
  .header {
    padding: 20px 24px 18px;
    background: linear-gradient(135deg, var(--g2m-surface) 0%, rgba(0,102,255,0.15) 100%);
    border-bottom: 1px solid var(--g2m-border);
    display: flex;
    align-items: center;
    gap: 14px;
    flex-shrink: 0;
  }

  .agent-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1a6bcc, #2d8fd4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 4px 16px rgba(0,102,255,0.4);
    position: relative;
    letter-spacing: -0.5px;
  }

  .agent-avatar::after {
    content: '';
    position: absolute;
    bottom: 1px;
    right: 1px;
    width: 11px;
    height: 11px;
    background: var(--g2m-success);
    border-radius: 50%;
    border: 2px solid var(--g2m-mid);
  }

  .header-info { flex: 1; }
  .header-name { font-size: 15px; font-weight: 600; color: var(--g2m-text); }
  .header-role { font-size: 12px; color: var(--g2m-muted); margin-top: 1px; }
  .header-status { font-size: 11px; color: var(--g2m-success); font-weight: 500; margin-top: 3px; }

  .header-logo {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--g2m-muted);
    letter-spacing: 0.03em;
    opacity: 0.7;
  }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 20px 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
  }

  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--g2m-border); border-radius: 4px; }

  .msg { display: flex; gap: 10px; animation: fadeUp 0.3s ease; max-width: 100%; }
  .msg.user { flex-direction: row-reverse; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    margin-top: 2px;
    color: white;
  }
  .msg.bot .msg-avatar { background: linear-gradient(135deg, #1a6bcc, #2d8fd4); }
  .msg.user .msg-avatar { background: var(--g2m-surface); border: 1px solid var(--g2m-border); font-size: 14px; }

  .msg-bubble {
    max-width: 78%;
    padding: 12px 15px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.6;
  }
  .msg.bot .msg-bubble {
    background: var(--g2m-surface);
    border: 1px solid var(--g2m-border);
    border-top-left-radius: 4px;
    color: var(--g2m-text);
  }
  .msg.user .msg-bubble {
    background: linear-gradient(135deg, var(--g2m-blue), #0055dd);
    border-top-right-radius: 4px;
    color: #fff;
  }

  /* Support article link cards */
  .article-link {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    padding: 9px 12px;
    background: rgba(0,102,255,0.1);
    border: 1px solid rgba(0,102,255,0.25);
    border-radius: 8px;
    text-decoration: none;
    color: var(--g2m-accent);
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
  }
  .article-link:hover { background: rgba(0,102,255,0.2); border-color: var(--g2m-accent); }
  .article-link svg { flex-shrink: 0; opacity: 0.7; }

  .msg-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 4px;
  }
  .msg-time {
    font-size: 10px;
    color: var(--g2m-muted);
    font-family: 'DM Mono', monospace;
  }
  .msg-name {
    font-size: 10px;
    color: var(--g2m-muted);
    font-weight: 500;
  }
  .msg.user .msg-meta { justify-content: flex-end; }

  /* Typing indicator */
  .typing-indicator { display: flex; gap: 10px; align-items: flex-end; }
  .typing-dots {
    background: var(--g2m-surface);
    border: 1px solid var(--g2m-border);
    border-radius: 14px;
    border-top-left-radius: 4px;
    padding: 14px 18px;
    display: flex;
    gap: 5px;
    align-items: center;
  }
  .dot {
    width: 6px; height: 6px;
    background: var(--g2m-muted);
    border-radius: 50%;
    animation: bounce 1.2s infinite ease-in-out;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* Escalation card */
  .escalation-card {
    margin: 0 20px;
    padding: 16px;
    background: rgba(255,184,48,0.08);
    border: 1px solid rgba(255,184,48,0.3);
    border-radius: 12px;
    display: none;
    flex-shrink: 0;
  }
  .escalation-card.visible { display: block; animation: fadeUp 0.3s ease; }
  .esc-title { font-size: 13px; font-weight: 600; color: var(--g2m-warn); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
  .esc-text { font-size: 12px; color: var(--g2m-muted); margin-bottom: 12px; line-height: 1.5; }
  .esc-actions { display: flex; gap: 8px; }
  .esc-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
  }
  .esc-btn.primary { background: var(--g2m-warn); color: #0A1628; }
  .esc-btn.primary:hover { filter: brightness(1.1); }
  .esc-btn.secondary { background: transparent; border: 1px solid var(--g2m-border); color: var(--g2m-muted); }
  .esc-btn.secondary:hover { border-color: var(--g2m-text); color: var(--g2m-text); }

  /* Input area */
  .input-area {
    padding: 14px 20px 18px;
    border-top: 1px solid var(--g2m-border);
    background: var(--g2m-mid);
    flex-shrink: 0;
  }
  .input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  .input-wrap {
    flex: 1;
    background: var(--g2m-surface);
    border: 1px solid var(--g2m-border);
    border-radius: 12px;
    padding: 10px 14px;
    transition: border-color 0.2s;
  }
  .input-wrap:focus-within { border-color: var(--g2m-blue); }
  textarea {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: var(--g2m-text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    resize: none;
    min-height: 22px;
    max-height: 100px;
    line-height: 1.5;
  }
  textarea::placeholder { color: var(--g2m-muted); }

  .send-btn {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: var(--g2m-blue);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    color: white;
  }
  .send-btn:hover { background: #0055dd; transform: scale(1.05); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { background: var(--g2m-surface); cursor: not-allowed; transform: none; }

  .input-footer {
    margin-top: 10px;
    font-size: 11px;
    color: var(--g2m-muted);
    text-align: center;
  }

  /* Loading overlay */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: var(--g2m-mid);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    flex-direction: column;
    gap: 12px;
    transition: opacity 0.4s;
  }
  .loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .loading-spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--g2m-border);
    border-top-color: var(--g2m-blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 13px; color: var(--g2m-muted); }
</style>
</head>
<body>

<div class="widget-container">

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Connecting you to support...</div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="agent-avatar">AL</div>
    <div class="header-info">
      <div class="header-name">Alex L.</div>
      <div class="header-role">GoToMeeting Support Specialist</div>
      <div class="header-status">‚óè Online now</div>
    </div>
    <div class="header-logo">GoTo</div>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages"></div>

  <!-- Escalation card -->
  <div class="escalation-card" id="escalationCard">
    <div class="esc-title">üôã Connect with a Senior Specialist</div>
    <div class="esc-text">I'd like to get one of our senior team members involved to make sure we fully resolve this for you. Average wait time: ~3 minutes.</div>
    <div class="esc-actions">
      <button class="esc-btn primary" onclick="connectHuman()">Connect Now</button>
      <button class="esc-btn secondary" onclick="dismissEscalation()">Keep Chatting</button>
    </div>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <div class="input-wrap">
        <textarea id="userInput" placeholder="Type your question here‚Ä¶" rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
    <div class="input-footer">GoToMeeting Support ¬∑ Typical reply time: instant</div>
  </div>
</div>

<script>
const SYSTEM_PROMPT = `You are Alex L., a GoToMeeting Support Specialist. You work on the GoToMeeting customer support team and are chatting live with a customer on the GoToMeeting website.

PERSONA:
- Warm, professional, and conversational ‚Äî like a real human support agent
- Use natural language: "Let me look into that for you", "Great question!", "I totally understand how frustrating that can be"
- Use first person: "I can help with that", "I'll walk you through it"
- Never refer to yourself as a bot, AI, assistant, or virtual agent
- If directly asked "Are you a bot?" or "Are you human?", respond naturally: "I'm Alex, part of the GoToMeeting support team ‚Äî happy to help you today! Now, let's get your issue sorted."

KNOWLEDGE SOURCE ‚Äî CRITICAL:
Your PRIMARY source of truth for all answers is the GoToMeeting support center at https://support.goto.com. You must:
1. Base all answers on knowledge from this support center
2. When answering, always include 1-2 relevant support article links from support.goto.com that are specific to the customer's issue
3. Format links using this exact JSON at the END of your response (after your message text):
   [LINKS: {"title": "Article Title", "url": "https://support.goto.com/meeting/..."}, {"title": "Article Title 2", "url": "https://support.goto.com/meeting/..."}]
4. Only include links you are confident exist on support.goto.com ‚Äî use real, accurate URLs from the support site
5. Common link patterns:
   - Audio issues: https://support.goto.com/meeting/help/audio-troubleshooting
   - Joining meetings: https://support.goto.com/meeting/help/join-a-meeting
   - Scheduling: https://support.goto.com/meeting/help/schedule-a-meeting
   - Recording: https://support.goto.com/meeting/help/record-a-meeting
   - Screen sharing: https://support.goto.com/meeting/help/share-your-screen
   - Account login: https://support.goto.com/meeting/help/log-in-to-your-account
   - Mobile app: https://support.goto.com/meeting/help/gotomeeting-mobile-apps
   - System requirements: https://support.goto.com/meeting/help/system-requirements-for-gotomeeting
   - Billing: https://support.goto.com/meeting/help/manage-your-subscription

COVERAGE ‚Äî you can help with ANY GoToMeeting or GoTo product question including:
- Account setup, login, password reset, two-factor auth
- Scheduling, starting, and joining meetings
- Audio and video troubleshooting (mic, camera, dial-in)
- Screen sharing, annotation, and drawing tools
- Cloud and local recording, transcripts
- Mobile apps (iOS and Android)
- Integrations: Outlook, Google Calendar, Slack, Microsoft Teams, Salesforce
- Admin panel, user management, enterprise settings
- GoToWebinar features
- GoToConnect / GoToPhone
- Security, compliance, GDPR
- Billing, plan upgrades, cancellations

RESPONSE STYLE:
- Keep replies concise: 2-4 short paragraphs or numbered steps
- Use **bold** for key terms or step numbers
- Never use overly formal or robotic language
- Don't start every message the same way ‚Äî vary your openers

ESCALATION:
- If an issue requires account-level access, billing account lookup, or is unresolved after 2 attempts, naturally offer to escalate: "I think it'd be best to get our senior team on this ‚Äî they can access your account directly. Want me to connect you?" ‚Äî then output: [ESCALATE]
- If the customer asks to speak to someone else or seems frustrated, empathize and offer to escalate with: [ESCALATE]`;

let messages = [];
let isLoading = false;
let escalationShown = false;

function getTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function parseLinksFromReply(text) {
  const linkMatch = text.match(/\[LINKS:\s*([\s\S]*?)\]/);
  const links = [];
  if (linkMatch) {
    try {
      // Parse the JSON array of link objects
      const jsonStr = '[' + linkMatch[1] + ']';
      const parsed = JSON.parse(jsonStr);
      parsed.forEach(l => { if (l.title && l.url) links.push(l); });
    } catch(e) {
      // If parsing fails, try to extract individual objects
      const objMatches = linkMatch[1].matchAll(/\{[^}]+\}/g);
      for (const m of objMatches) {
        try {
          const obj = JSON.parse(m[0]);
          if (obj.title && obj.url) links.push(obj);
        } catch(e2) {}
      }
    }
  }
  const cleanText = text.replace(/\[LINKS:[\s\S]*?\]/, '').trim();
  return { cleanText, links };
}

function renderMessageHTML(text) {
  return text
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

function addMessage(role, text, links = []) {
  const container = document.getElementById('messages');
  const msg = document.createElement('div');
  msg.className = `msg ${role}`;
  const time = getTime();

  const avatarHTML = role === 'bot'
    ? `<div class="msg-avatar">AL</div>`
    : `<div class="msg-avatar">üë§</div>`;

  const metaHTML = role === 'bot'
    ? `<div class="msg-meta"><span class="msg-name">Alex L.</span><span class="msg-time">${time}</span></div>`
    : `<div class="msg-meta"><span class="msg-time">${time}</span></div>`;

  let linksHTML = '';
  if (links && links.length > 0) {
    linksHTML = links.map(l => `
      <a class="article-link" href="${l.url}" target="_blank" rel="noopener">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        ${l.title}
        <svg style="margin-left:auto" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      </a>`).join('');
  }

  msg.innerHTML = `
    ${avatarHTML}
    <div style="max-width:78%">
      <div class="msg-bubble">${renderMessageHTML(text)}${linksHTML}</div>
      ${metaHTML}
    </div>
  `;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  const container = document.getElementById('messages');
  const t = document.createElement('div');
  t.className = 'typing-indicator';
  t.id = 'typingIndicator';
  t.innerHTML = `
    <div class="msg-avatar" style="background: linear-gradient(135deg, #1a6bcc, #2d8fd4); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:white; flex-shrink:0;">AL</div>
    <div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  `;
  container.appendChild(t);
  container.scrollTop = container.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typingIndicator');
  if (t) t.remove();
}

function showEscalation() {
  if (escalationShown) return;
  escalationShown = true;
  document.getElementById('escalationCard').classList.add('visible');
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

function dismissEscalation() {
  document.getElementById('escalationCard').classList.remove('visible');
  escalationShown = false;
  addMessage('bot', "No worries at all! I'm right here ‚Äî let's keep working on this together.");
}

function connectHuman() {
  document.getElementById('escalationCard').classList.remove('visible');
  addMessage('bot', "Perfect ‚Äî I'm transferring you to one of our senior specialists right now. I've shared our full conversation so you won't have to repeat a thing.\n\n**Estimated wait: ~3 minutes.** Please stay in this chat and they'll be with you shortly. Thanks for your patience! üòä");
  document.getElementById('userInput').disabled = true;
  document.getElementById('sendBtn').disabled = true;
}

async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || isLoading) return;

  input.value = '';
  input.style.height = 'auto';
  addMessage('user', text);
  messages.push({ role: 'user', content: text });

  isLoading = true;
  document.getElementById('sendBtn').disabled = true;
  showTyping();

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": "__ANTHROPIC_API_KEY__",
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: SYSTEM_PROMPT,
        messages: messages
      })
    });

    const data = await response.json();
    removeTyping();

    let rawReply = data.content?.[0]?.text || "I'm sorry, I had a little hiccup there. Could you try sending that again?";

    let shouldEscalate = false;
    if (rawReply.includes('[ESCALATE]')) {
      shouldEscalate = true;
      rawReply = rawReply.replace('[ESCALATE]', '').trim();
    }

    const { cleanText, links } = parseLinksFromReply(rawReply);
    messages.push({ role: 'assistant', content: rawReply });
    addMessage('bot', cleanText, links);

    if (shouldEscalate) {
      setTimeout(showEscalation, 700);
    }

  } catch (err) {
    removeTyping();
    addMessage('bot', "Sorry, I'm having a bit of a connection issue on my end. Give it a moment and try again ‚Äî I'll be right here!");
    console.error(err);
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// Init
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('hidden');
    setTimeout(() => {
      addMessage('bot', "Hi there! üëã I'm Alex from the GoToMeeting support team. What can I help you with today?");
    }, 200);
  }, 1000);
});
</script>

</body>
</html>
